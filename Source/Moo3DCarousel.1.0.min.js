/*
---
description: Provide a simple way to create 3D carousel.

license: MIT-style
copyright: Patrick Allain
authors: Patrick Allain

requires:
- core/1.2.4:: [Class.Extras, Element.Event, Element.Style, Element.Dimension, Fx.Morph]

provides: [Moo3DCarousel]

...
*/
var Moo3DCarousel=new Class({Implements:[Events,Options],options:{containerPosition:"relative",margin:10,centerOffset:{x:0,y:0},xRadius:300,yRadius:50,rotateDuration:500,fx:{link:"cancel"},ratioMin:0.4,offsetAngle:0,zIndex:100,powerExponent:0.85,mouseWheel:true,autoRun:true,interval:3E3,stopOver:true,trigo:true},_container:null,_elements:[],_sizeMax:{x:0,y:0},_currentIndex:0,_center:{x:0,y:0},_evFunct:{},_periodical:null,_autorun:false,initialize:function(a,c){a=document.id(a);this.setOptions(c); this._container=(new Element("div",{"class":"Moo3DCarouselOverlay"})).setStyles({position:this.options.containerPosition,"z-index":this.options.zIndex}).inject(a);this._evFunct={wheel:function(b){b.stop();this[b.wheel==1?"goNext":"goPrevious"]()}.bind(this),winResize:function(){this.init()}.bind(this),mouseEnter:function(){$clear(this._periodical);this.fireEvent("stop");this._autorun=false}.bind(this),mouseLeave:function(){$clear(this._periodical);this._periodical=this.goNext.periodical(this.options.interval, this);this.fireEvent("start");this._autorun=true}.bind(this)};this.options.mouseWheel&&this._container.addEvent("mousewheel",this._evFunct.wheel);window.addEvent("resize",this._evFunct.winResize);if(this.options.autoRun){this._evFunct.mouseLeave();this.options.stopOver&&this._container.addEvents({mouseenter:this._evFunct.mouseEnter,mouseleave:this._evFunct.mouseLeave})}},addElement:function(a,c){a=document.id(a);a.inject(this._container);this._elements.push(a);var b=a.get("tag")=="img"?a:a.getElement("img"); b.setStyle("position","absolute");c=c||{};c.x=c.x||b.getProperty("width").toInt()||el.getSize().x;c.y=c.y||b.getProperty("height").toInt()||el.getSize().y;a.store("Moo3DCarousel:size",c);var d={};["top","right","bottom","left"].each(function(e){d[e]=b.getStyle("border-size-"+e).toInt()||0});this._sizeMax={x:Math.max(c.x+d.left+d.right,this._sizeMax.x),y:Math.max(c.y+d.top+d.bottom,this._sizeMax.y)};a.store("Moo3DCarousel:fx",new Fx.Morph(b,$extend({duration:this.options.rotateDuration}),this.options.fx)); this.init();return this},getSize:function(){return{x:this._sizeMax.x+2*(this.options.margin+this.options.xRadius),y:this._sizeMax.y+2*(this.options.margin+this.options.yRadius)}},init:function(a){this._currentIndex=a||this._currentIndex;this._center={x:this._container.getSize().x/2+this.options.centerOffset.x,y:this.options.centerOffset.y+this.options.yRadius};this._container.setStyle("height",this.getSize().y);for(var c=this._elements.length,b=0;b<c;b++){var d=this._elements[b],e=d.get("tag")=="img"? d:d.getElement("img");a=(b+c-this._currentIndex)%c;a=this._getTeta(a);d=this._getStyles(d,a);e.setStyles(d)}this.fireEvent("init");return this},_getTeta:function(a){a%=this._elements.length;a=a/this._elements.length*2*Math.PI;a=(a+Math.PI)%(2*Math.PI)-Math.PI;return a=(a>0?1:-1)*Math.PI*Math.pow(Math.abs(a)/Math.PI,this.options.powerExponent)},_getStyles:function(a,c){var b=a.retrieve("Moo3DCarousel:size",a.getSize()),d=(1-this.options.ratioMin)/2;d=1+d*(Math.cos(c)-1);b={width:(b.x*d).toInt(),height:(b.y* d).toInt()};$extend(b,{"z-index":(this.options.zIndex+d*2*this._elements.length).toInt()});$extend(b,{left:(this._center.x+this.options.xRadius*Math.sin(c+this.options.offsetAngle)-b.width/2).toInt(),top:(this._center.y+this.options.yRadius*Math.cos(c+this.options.offsetAngle)).toInt()});return b},focus:function(a){a=document.id(a);a=this._elements.indexOf(a);a!=-1&&this.goTo(a);return this},goPrevious:function(){return this.goTo(this._currentIndex-(this.options.trigo?-1:1))},goNext:function(){return this.goTo(this._currentIndex+ (this.options.trigo?-1:1))},goTo:function(a){this.init();this._currentIndex=a%this._elements.length;for(var c=this._elements.length,b=0;b<c;b++){var d=this._elements[b],e=d.retrieve("Moo3DCarousel:fx");a=(b+c-this._currentIndex)%c;a=this._getTeta(a);d=this._getStyles(d,a);e.start(d)}if(this._autorun){$clear(this._periodical);this._periodical=this.goNext.periodical(this.options.interval,this)}this.fireEvent("rotateStart",this);this.fireEvent("rotateEnd",this,this.options.rotateDuration);return this}, count:function(){return this._elements.length},toElement:function(){return this._container},getFocused:function(){var a=this._elements.length;return this._elements[(this._currentIndex+a)%a]}});Element.implement({moo3DCarousel:function(a){var c=this.getChildren(),b=new Moo3DCarousel(this,a);c.each(function(d){b.addElement(d)});return this}});

